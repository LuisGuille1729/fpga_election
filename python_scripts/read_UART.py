import serial
import sys
import time

from paillier import generate_keys, decrypt

# SERIAL_PORTNAME = "/dev/ttyUSB1"
SERIAL_PORTNAME = "/dev/cu.usbserial-8874292301971"

BAUD = 9600

ser = serial.Serial(SERIAL_PORTNAME, BAUD)

def read_UART():
    return ser.read()

software_decrypt = True

if software_decrypt:
    keys = generate_keys(generate_new=False, verbose=False)
    R_inverse = 81107639473872834862113160384587320505523681558308765561730460247589367636768099250959892926052788716221642552001139066815430567724344860583094243399736604136036937648928790764214416217951032207962309514754178084415447845641019335236679267431433119633245835662314870225975735960080986675999018544597031916700082197447731757331227648495676662127494563984609210881880262024711247896899271401123070539625781199441213299344824755371532711794411004593387207343171154694641025452736023477511533124921413766289410513644881125945554190822796304535623877818134706173653271145599695436068194617130535034171922426463589880815496060798780207388031145331065527728531271242491607203536076325279896483059756225312519985550978966934445095398386444334812097663868943921962473093468666185967862184613865127974750849105162079000335117677294111513038393051091619010878712049841141007755851239397551286050997004771575115216738471204786137390538447029669135710832418064692111189112621983088952873546418413707394233584124680888786573912063405304390478543315596591709252821498200463571641321827454439345060414450593247920183187777785231130217770494721592602618909655619784871745918950283071905258613686252409973737912390260494262666549989272981989941524185

i = 0
while True:
    time.sleep(0.1)
    ciphertext_mont = int.from_bytes(ser.read(512),byteorder='little')
    print(f"-------------VOTE {i}------------------\n")
    print(f"Montgomery Ciphertext: {hex(ciphertext_mont)}\n")
    
    if software_decrypt:
        ciphertext = (ciphertext_mont * R_inverse) % keys.public.n_square

        # print(f"True Ciphertext: {ciphertext}\n")

        decrypted_vote = decrypt(keys, ciphertext)
        print(f"[Software Check] Decrypt(ciphertext): {decrypted_vote}\n")

        # wrong_decrypted = decrypt(keys, ciphertext_mont)
        # print("Wrong decrypt", wrong_decrypted)
    
    print(f"-------------------------------------\n")
    
    i += 1
    
    